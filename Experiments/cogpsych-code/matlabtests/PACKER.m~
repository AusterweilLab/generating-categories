function preds = PACKER(parms,stimTest,stimTrain,categories,task)
% PACKER model of categorisation
% Written to see if the python version is actually making any sense.
% Parms is a vector of [specificity, tradeoff, determinism]
% Task can be 'generate' or 'assign'. 'generate' will yield predictions of
% the probability that a stimulus is generated as category 1
% given the training stim, and 'assign' will yield predictions of the 
% probability that a stimulus is assigned as category 0.
% 270218 Start

nStimTest = size(stimTest,1);
nStimTrain = size(stimTrain,1);
nDim = size(stimTrain,2);
w_k = ones(nStimTrain,nDim);
specificity = parms(1);
tradeoff = parms(2);
determinism = parms(3);

if nDim~=2
    error('Fix genera
for k = 1:nDim
    %This will need to be fixed if nDim>2    
    fx = repmat(tradeoff,nStimTrain,1); %gammas
    fx(categories==(k-1)) = 1-tradeoff;
end

similarity = zeros(nStimTest,nDim);
for i = 1:nStimTest
    currStimTest = stimTest(i,:);
    distance = zeros(nStimTrain,1);
    for j = 1:nStimTrain         
        currStimTrain = stimTrain(j,:);
        diff = currStimTest-currStimTrain;
        weighted_diff = diff .* w_k;
        summed_diff = sum(weighted_diff,2);
        distance(j,1) = exp(-specificity*summed_diff);
    end
    for k = 1:nDim

        similarity(i,k) = sum(fx .* distance);
    end
end
exp_sim = exp(similarity);


switch task
    case 'generate'
        sum_sim = sum(exp_sim); %across all stim
        p = exp_sim ./ sum_sim;
    case 'assign'
        
        sum_sim = sum(exp_sim); %across all dim
        exp_sim
end





